(()=>{"use strict";(()=>{const e=document.querySelector(".ad-form").querySelector("input[name = address]"),t=e=>{e.remove()};window.util={setDisable:(e,t)=>{e.forEach((e=>{e.disabled=t}))},getNewMainPinAddress:(t,n,o)=>{e.value=`${t+Math.floor(32.5)}, ${n+o}`},closePopup:t,createEscHandler:e=>{const n=o=>{"Escape"===o.key&&(o.preventDefault(),t(e),document.removeEventListener("keydown",n))};return n}}})(),window.upload={sendData:(e,t,n)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?t():n()})),o.addEventListener("error",(()=>{n()})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},window.load={getData:(e,t)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=5e3,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()}},(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.createDocumentFragment(),n=document.querySelector(".map"),o=n.querySelector(".map__filters-container");window.card={renderAdPopup:t=>{const n=e.cloneNode(!0);n.querySelector(".popup__title").textContent=t.offer.title,n.querySelector(".popup__text--address").textContent=t.offer.address,n.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=t.offer.type,n.querySelector(".popup__text--capacity").textContent=t.offer.rooms+" комнаты для "+t.offer.guests,n.querySelector(".popup__text--time").textContent="Заезд после "+t.offer.checkin+", выезд до "+t.offer.checkout;const o=n.querySelector(".popup__features");t.offer.features.forEach((e=>{const t=document.createElement("li");t.className="popup__feature popup__feature--"+e,o.appendChild(t)})),n.querySelector(".popup__description").textContent=t.offer.description;const r=n.querySelector(".popup__photos");return t.offer.photos.forEach((e=>{const t=document.createElement("img");t.className="popup__photo",t.src=e,t.width=45,t.height=40,t.alt="Фотография жилья",r.appendChild(t)})),n.querySelector(".popup__avatar").src=t.author.avatar,n},openPopup:e=>{const r=n.querySelector(".map__card");r&&r.remove(),t.appendChild(e),n.insertBefore(t,o),document.addEventListener("keydown",window.util.createEscHandler(e))}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={renderAd:t=>{const n=e.cloneNode(!0);n.style=`left: ${t.location.x+50}px; top: ${t.location.y+70}px;`;const o=n.querySelector("img");return o.src=t.author.avatar,o.alt=t.offer.title,n}}})(),(()=>{const e=document.createDocumentFragment(),t=document.querySelector(".map").querySelector(".map__pins"),n=document.createElement("div");n.classList.add("pins__container"),window.render={createAd:o=>{const r=o.length>5?5:o.length;n.innerHTML="";for(let t=0;t<r;t++){const n=window.pin.renderAd(o[t]),r=window.card.renderAdPopup(o[t]),d=r.querySelector(".popup__close");e.appendChild(n),n.addEventListener("click",(()=>{window.card.openPopup(r)})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&window.card.openPopup(r)})),d.addEventListener("click",(()=>{window.util.closePopup(r)}))}n.appendChild(e),t.appendChild(n)}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n={top:130,right:e.offsetWidth-t.clientWidth/2,left:-t.clientWidth/2,bottom:630};window.move={getNewLocation:(e,o)=>{let r={x:n.left,y:n.top};e>n.right?r.x=n.right:e>n.left&&(r.x=e),o>n.bottom?r.y=n.bottom:o>n.top&&(r.y=o),(e=>{t.style.left=e.x+"px",t.style.top=e.y+"px",window.util.getNewMainPinAddress(e.x,e.y,87)})(r)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("select[name = capacity]"),n=e.querySelector("input[name = price]"),o=document.createDocumentFragment(),r={1:["для 1 гостя"],2:["для 1 гостя","для 2 гостей"],3:["для 1 гостя","для 2 гостей","для 3 гостей"],100:["не для гостей"]},d={bungalow:0,flat:1e3,house:5e3,palace:1e4};window.form={renderCapacityList:e=>{t.innerHTML="",r[e].forEach(((e,t)=>{o.appendChild(((e,t)=>{const n=document.createElement("option");return n.textContent=e,n.value=t,n})(e,t+1))})),t.appendChild(o)},getPrice:e=>{n.min=d[e],n.max=1e6,n.placeholder=d[e]},synchronizeSelects:(e,t)=>{e.selectedIndex=[...e].findIndex((e=>e.value===t))},validateTextInput:(e,t,n)=>{const o=e.value.length;o<t?e.setCustomValidity("Ещё "+(t-o)+" символов"):o>n?e.setCustomValidity("Удалите лишние "+(o-n)+" символов"):e.setCustomValidity(""),e.reportValidity()}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),o=n.querySelectorAll("fieldset"),r=n.querySelector("input[name = title]"),d=n.querySelector("select[name = rooms]"),c=n.querySelector("select[name = type]"),a=n.querySelector("select[name = timein]"),i=n.querySelector("select[name = timeout]"),s=n.querySelector(".ad-form__reset"),l=document.querySelector(".map__filters"),u=l.querySelectorAll("select"),p=l.querySelector("select[name = housing-type]"),m=document.querySelector("#success").content.querySelector(".success"),y=document.querySelector("#error").content.querySelector(".error");let w=t.offsetLeft,f=t.offsetTop;const v=()=>{e.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),window.util.setDisable(o,!1),window.util.setDisable(u,!1),window.load.getData(h,E)},S=()=>{e.classList.add("map--faded"),e.querySelector(".pins__container").innerHTML="",n.classList.add("ad-form--disabled"),window.util.setDisable(o,!0),window.util.setDisable(u,!0),n.reset(),window.util.getNewMainPinAddress(570,375,65),t.style.left="570px",t.style.top="375px"};window.util.setDisable(o,!0),window.util.setDisable(u,!0),window.form.renderCapacityList(d.value),window.form.getPrice(c.value),window.util.getNewMainPinAddress(w,f,65),t.addEventListener("mousedown",(e=>{e.preventDefault();let n={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();const o=n.x-e.clientX,r=n.y-e.clientY;n={x:e.clientX,y:e.clientY},w=t.offsetLeft,f=t.offsetTop,window.move.getNewLocation(w-o,f-r)},r=e=>{e.preventDefault(),o(e),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r),1===e.which&&(v(),window.util.getNewMainPinAddress(w,f,87))})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&(v(),window.util.getNewMainPinAddress(w,f,87))})),n.addEventListener("submit",(e=>{e.preventDefault(),window.upload.sendData(new FormData(n),x,L)})),d.addEventListener("change",(e=>{const t=e.target.options,n=t[t.selectedIndex].value;window.form.renderCapacityList(n)})),c.addEventListener("change",(e=>{const t=e.target.options,n=t[t.selectedIndex].value;window.form.getPrice(n)})),r.addEventListener("input",(()=>{window.form.validateTextInput(r,30,100)})),a.addEventListener("change",(e=>{const t=e.target.options,n=t[t.selectedIndex].value;window.form.synchronizeSelects(i,n)})),i.addEventListener("change",(e=>{const t=e.target.options,n=t[t.selectedIndex].value;window.form.synchronizeSelects(a,n)})),s.addEventListener("click",(()=>{S()}));let q="any",_=[];const g=()=>{const e=_.filter((e=>e.offer.type===q)).concat(_),t=e.filter(((t,n)=>e.indexOf(t)===n));window.render.createAd(t)};p.addEventListener("change",(()=>{const e=p.value;q=e,g();const t=document.querySelector(".map__card");t&&window.util.closePopup(t)}));const h=e=>{_=e,g()},E=e=>{const t=document.createElement("div");t.style="z-index: 100; padding: 15px 0; width: 100%; text-align: center; color: #FFFFFF; background-color: rgb(255, 36, 0);",t.style.position="fixed",t.style.left=0,t.style.top=0,t.style.fontSize="28px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},x=()=>{document.body.insertAdjacentElement("afterbegin",m),document.addEventListener("keydown",window.util.createEscHandler(document.querySelector(".success"))),S()},L=()=>{document.querySelector("main").insertAdjacentElement("afterbegin",y);const e=document.querySelector(".error");document.addEventListener("keydown",window.util.createEscHandler(e)),e&&e.addEventListener("click",(()=>{e.remove()}))}})()})();