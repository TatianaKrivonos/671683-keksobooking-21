(()=>{"use strict";(()=>{const e=document.querySelector(".ad-form").querySelector("input[name = address]"),t=e=>{e.remove()};window.util={setDisable:(e,t)=>{e.forEach((e=>{e.disabled=t}))},getNewMainPinAddress:(t,n,o)=>{e.value=`${t+Math.floor(32.5)}, ${n+o}`},closePopup:t,createEscHandler:e=>{const n=o=>{"Escape"===o.key&&(o.preventDefault(),t(e),document.removeEventListener("keydown",n))};return n}}})(),window.upload={sendData:(e,t,n)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?t():n()})),o.addEventListener("error",(()=>{n()})),o.open("POST","https://21.javascript.pages.academy/keksobooking"),o.send(e)}},window.load={getData:(e,t)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?e(n.response):t("Статус ответа: "+n.status+" "+n.statusText)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.timeout=5e3,n.open("GET","https://21.javascript.pages.academy/keksobooking/data"),n.send()}},(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.createDocumentFragment(),n=document.querySelector(".map"),o=n.querySelector(".map__filters-container");window.card={renderAdPopup:t=>{const n=e.cloneNode(!0);n.querySelector(".popup__title").textContent=t.offer.title,n.querySelector(".popup__text--address").textContent=t.offer.address,n.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",n.querySelector(".popup__type").textContent=t.offer.type,n.querySelector(".popup__text--capacity").textContent=t.offer.rooms+" комнаты для "+t.offer.guests,n.querySelector(".popup__text--time").textContent="Заезд после "+t.offer.checkin+", выезд до "+t.offer.checkout;const o=n.querySelector(".popup__features");t.offer.features.forEach((e=>{const t=document.createElement("li");t.className="popup__feature popup__feature--"+e,o.appendChild(t)})),n.querySelector(".popup__description").textContent=t.offer.description;const r=n.querySelector(".popup__photos");return t.offer.photos.forEach((e=>{const t=document.createElement("img");t.className="popup__photo",t.src=e,t.width=45,t.height=40,t.alt="Фотография жилья",r.appendChild(t)})),n.querySelector(".popup__avatar").src=t.author.avatar,n},openPopup:e=>{const r=n.querySelector(".map__card");r&&r.remove(),t.appendChild(e),n.insertBefore(t,o),document.addEventListener("keydown",window.util.createEscHandler(e))}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={renderAd:t=>{const n=e.cloneNode(!0);n.style=`left: ${t.location.x+50}px; top: ${t.location.y+70}px;`;const o=n.querySelector("img");return o.src=t.author.avatar,o.alt=t.offer.title,n}}})(),(()=>{const e=document.createDocumentFragment(),t=document.querySelector(".map").querySelector(".map__pins"),n=document.createElement("div");n.classList.add("pins__container"),window.render={createAd:o=>{const r=o.length>5?5:o.length;n.innerHTML="";for(let t=0;t<r;t++){const n=window.pin.renderAd(o[t]),r=window.card.renderAdPopup(o[t]),s=r.querySelector(".popup__close");e.appendChild(n),n.addEventListener("click",(()=>{window.card.openPopup(r)})),n.addEventListener("keydown",(e=>{"Enter"===e.key&&window.card.openPopup(r)})),s.addEventListener("click",(()=>{window.util.closePopup(r)}))}n.appendChild(e),t.appendChild(n)}}})(),(()=>{const e=document.querySelector(".map__filters"),t=e.querySelector("select[name = housing-type]"),n=e.querySelector("select[name = housing-price]"),o=e.querySelector("select[name = housing-rooms]"),r=e.querySelector("select[name = housing-guests]"),s=e.querySelectorAll(".map__checkbox"),i=()=>{const e=document.querySelector(".map__card");e&&window.util.closePopup(e)},a={onHousingTypeChange:e=>{},onHousingPriceChange:e=>{},onHousingRoomsChange:e=>{},onHousingGuestsChange:e=>{},onHousingFeaturesChange:e=>{}};t.addEventListener("change",(()=>{const e=t.value;a.onHousingTypeChange(e),i()})),n.addEventListener("change",(()=>{const e=n.value;a.onHousingPriceChange(e),i()})),o.addEventListener("change",(()=>{const e=o.value;a.onHousingRoomsChange(e),i()})),r.addEventListener("change",(()=>{const e=r.value;a.onHousingGuestsChange(e),i()})),s.forEach((e=>{e.addEventListener("click",(()=>{const t=[];if(e.checked)t.push(e.value);else{const n=t.indexOf(e);t.splice(n,1)}a.onHousingFeaturesChange(t),i()}))})),window.filter={setHousingTypeHandler:e=>{a.onHousingTypeChange=e},setHousingPriceHandler:e=>{a.onHousingPriceChange=e},setHousingRoomsHandler:e=>{a.onHousingRoomsChange=e},setHousingGuestsHandler:e=>{a.onHousingGuestsChange=e},setHousingFeaturesHandler:e=>{a.onHousingFeaturesChange=e}}})(),window.debounce={setClickInterval:e=>{let t=null;return(...n)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...n)}),500)}}},(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n={top:43,right:e.offsetWidth-Math.floor(t.clientWidth/2),left:-Math.floor(t.clientWidth/2),bottom:543};window.move={getNewLocation:(e,o)=>{let r={x:n.left,y:n.top};e>n.right?r.x=n.right:e>n.left&&(r.x=e),o>n.bottom?r.y=n.bottom:o>n.top&&(r.y=o),(e=>{t.style.left=e.x+"px",t.style.top=e.y+"px",window.util.getNewMainPinAddress(e.x,e.y,87)})(r)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("select[name = capacity]"),n=e.querySelector("input[name = price]"),o=document.createDocumentFragment(),r={100:["не для гостей"],1:["для 1 гостя"],2:["для 1 гостя","для 2 гостей"],3:["для 1 гостя","для 2 гостей","для 3 гостей"]},s={"не для гостей":0,"для 1 гостя":1,"для 2 гостей":2,"для 3 гостей":3},i={bungalow:0,flat:1e3,house:5e3,palace:1e4};window.form={renderCapacityList:e=>{t.innerHTML="",r[e].forEach((e=>{o.appendChild((e=>{const t=document.createElement("option");return t.textContent=e,t.value=s[e],t})(e))})),t.appendChild(o)},getPrice:e=>{n.min=i[e],n.max=1e6,n.placeholder=i[e]},synchronizeSelects:(e,t)=>{e.selectedIndex=[...e].findIndex((e=>e.value===t))},validateTextInput:(e,t,n)=>{const o=e.value.length;o<t?e.setCustomValidity("Ещё "+(t-o)+" символов"):o>n?e.setCustomValidity("Удалите лишние "+(o-n)+" символов"):e.setCustomValidity(""),e.reportValidity()}}})(),(()=>{const e=["gif","jpg","jpeg","png","svg"],t=document.querySelector(".ad-form"),n=t.querySelector(".ad-form__field input[type=file]"),o=t.querySelector(".ad-form-header__preview img"),r=t.querySelector(".ad-form__upload input[type=file]"),s=t.querySelector(".ad-form__photo"),i=document.createElement("img");i.src="img/muffin-grey.svg",i.width=70,i.height=70;const a=[o,s.appendChild(i)];[n,r].forEach(((t,n)=>{t.addEventListener("change",(()=>{const o=t.files[0],r=o.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{a[n].src=e.result})),e.readAsDataURL(o)}}))}))})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),o=n.querySelectorAll("fieldset"),r=n.querySelector("input[name = title]"),s=n.querySelector("select[name = rooms]"),i=n.querySelector("select[name = type]"),a=n.querySelector("select[name = timein]"),d=n.querySelector("select[name = timeout]"),c=n.querySelector(".ad-form__reset"),l=document.querySelector(".map__filters").querySelectorAll("select"),u=document.querySelector("#success").content.querySelector(".success"),p=document.querySelector("#error").content.querySelector(".error"),m=n.querySelector(".ad-form-header__preview img"),w=n.querySelector(".ad-form__photo img");let f=t.offsetLeft,y=t.offsetTop;const g=()=>{e.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),window.util.setDisable(o,!1),window.util.setDisable(l,!1),window.load.getData(P,D)},h=()=>{e.classList.add("map--faded"),e.querySelector(".pins__container").innerHTML="",n.classList.add("ad-form--disabled"),window.util.setDisable(o,!0),window.util.setDisable(l,!0),n.reset(),window.util.getNewMainPinAddress(570,375,65),t.style.left="570px",t.style.top="375px",m.src="img/muffin-grey.svg",w.src="img/muffin-grey.svg",window.form.getPrice(i.value),window.form.renderCapacityList(s.value)};window.util.setDisable(o,!0),window.util.setDisable(l,!0),window.form.renderCapacityList(s.value),window.form.getPrice(i.value),window.util.getNewMainPinAddress(f,y,65),t.addEventListener("mousedown",(e=>{e.preventDefault();let n={x:e.clientX,y:e.clientY};const o=e=>{e.preventDefault();const o=n.x-e.clientX,r=n.y-e.clientY;n={x:e.clientX,y:e.clientY},f=t.offsetLeft,y=t.offsetTop,window.move.getNewLocation(f-o,y-r)},r=e=>{e.preventDefault(),o(e),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r)};document.addEventListener("mousemove",o),document.addEventListener("mouseup",r),1===e.which&&(g(),window.util.getNewMainPinAddress(f,y,87))})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&(g(),window.util.getNewMainPinAddress(f,y,87))})),n.addEventListener("submit",(e=>{e.preventDefault(),window.upload.sendData(new FormData(n),A,T)})),s.addEventListener("change",(e=>{const t=e.target.options,n=t[t.selectedIndex].value;window.form.renderCapacityList(n)})),i.addEventListener("change",(e=>{const t=e.target.options,n=t[t.selectedIndex].value;window.form.getPrice(n)})),r.addEventListener("input",(()=>{window.form.validateTextInput(r,30,100)})),a.addEventListener("change",(e=>{const t=e.target.options,n=t[t.selectedIndex].value;window.form.synchronizeSelects(d,n)})),d.addEventListener("change",(e=>{const t=e.target.options,n=t[t.selectedIndex].value;window.form.synchronizeSelects(a,n)})),c.addEventListener("click",(()=>{h()}));let v="any",_="any",S="any",q="any",E=[],L=[];const C={any:e=>e>0,middle:e=>e>1e4&&e<5e4,low:e=>e<1e4,high:e=>e>5e4},x={any:e=>e>0,1:e=>1===e,2:e=>2===e,3:e=>3===e},H={any:e=>e>0,1:e=>1===e,2:e=>2===e,0:e=>0===e},b=e=>{const t=e.offer.features;let n=0;return e.offer.type===v&&(n+=5),C[_](e.offer.price)&&(n+=4),x[S](e.offer.rooms)&&(n+=3),H[q](e.offer.guests)&&(n+=2),E.some((e=>t.includes(e)))&&(n+=1),n},k=()=>{window.render.createAd(L.sort(((e,t)=>{let n=b(t)-b(e);var o,r;return 0===n&&(o=e.offer.features,r=t.offer.features,n=o.length>r.length?1:o.length<r.length?-1:0),n})))};window.filter.setHousingTypeHandler(window.debounce.setClickInterval((e=>{v=e,k()}))),window.filter.setHousingPriceHandler(window.debounce.setClickInterval((e=>{_=e,k()}))),window.filter.setHousingRoomsHandler(window.debounce.setClickInterval((e=>{S=e,k()}))),window.filter.setHousingGuestsHandler(window.debounce.setClickInterval((e=>{q=e,k()}))),window.filter.setHousingFeaturesHandler(window.debounce.setClickInterval((e=>{E=e,k()})));const P=e=>{L=e,k()},D=e=>{const t=document.createElement("div");t.style="z-index: 100; padding: 15px 0; width: 100%; text-align: center; color: #FFFFFF; background-color: rgb(255, 36, 0);",t.style.position="fixed",t.style.left=0,t.style.top=0,t.style.fontSize="28px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},A=()=>{document.body.insertAdjacentElement("afterbegin",u),document.addEventListener("keydown",window.util.createEscHandler(document.querySelector(".success"))),h()},T=()=>{document.querySelector("main").insertAdjacentElement("afterbegin",p);const e=document.querySelector(".error");document.addEventListener("keydown",window.util.createEscHandler(e)),e&&e.addEventListener("click",(()=>{e.remove()}))}})()})();