(()=>{"use strict";(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__filters"),o=e.querySelector(".map__pins"),n=document.querySelector(".ad-form");window.global={map:e,filtersForm:t,similarAdElement:o,adForm:n}})(),(()=>{const e=window.global.adForm.querySelector("input[name = address]");window.util={isEnter:e=>"Enter"===e.key,setDisable:(e,t)=>{e.forEach((e=>{e.disabled=t}))},getNewMainPinAddress:(t,o,n)=>{e.value=`${t+Math.floor(32.5)}, ${o+n}`}}})(),window.upload={sendData:(e,t,o)=>{const n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(()=>{200===n.status?t():o()})),n.addEventListener("error",(()=>{o()})),n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e)}},window.load={getData:(e,t)=>{const o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(()=>{200===o.status?e(o.response):t("Статус ответа: "+o.status+" "+o.statusText)})),o.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),o.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+o.timeout+"мс")})),o.timeout=5e3,o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()}},(()=>{const e=document.querySelector("#card").content.querySelector(".map__card"),t=document.createDocumentFragment(),o=window.global.map.querySelector(".map__filters-container");let n=[];const r={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"};window.card={openPopup:a=>{const i=(t=>{const o=e.cloneNode(!0);o.querySelector(".popup__title").textContent=t.offer.title,o.querySelector(".popup__text--address").textContent=t.offer.address,o.querySelector(".popup__text--price").textContent=t.offer.price+"₽/ночь",o.querySelector(".popup__type").textContent=r[t.offer.type],o.querySelector(".popup__text--capacity").textContent=t.offer.rooms+" комнаты для "+t.offer.guests,o.querySelector(".popup__text--time").textContent="Заезд после "+t.offer.checkin+", выезд до "+t.offer.checkout;const n=o.querySelector(".popup__features");t.offer.features.forEach((e=>{const t=document.createElement("li");t.classList.add("popup__feature","popup__feature--"+e),n.appendChild(t)})),o.querySelector(".popup__description").textContent=t.offer.description;const a=o.querySelector(".popup__photos");return t.offer.photos.forEach((e=>{const t=document.createElement("img");t.classList.add("popup__photo"),t.src=e,t.width=45,t.height=40,t.alt="Фотография жилья",a.appendChild(t)})),o.querySelector(".popup__avatar").src=t.author.avatar,o})(a);t.appendChild(i),window.global.map.insertBefore(t,o);const s=(e=>{const t=()=>{n.forEach((e=>e())),n=[],document.removeEventListener("keydown",t),e.remove()};return t})(i);return document.addEventListener("keydown",s),i.addEventListener("click",s),{closed:e=>n.push(e),close:s}}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={renderAd:t=>{const o=e.cloneNode(!0);o.style=`left: ${t.location.x-Math.floor(25)}px; top: ${t.location.y-70}px;`;const n=o.querySelector("img");return n.src=t.author.avatar,n.alt=t.offer.title,o}}})(),(()=>{const e=document.createDocumentFragment(),t=document.createElement("div");t.classList.add("pins__container");let o=null,n=null;const r=(e,t)=>{e.classList.add("map__pin--active"),n=e,o&&o.close(),o=window.card.openPopup(t),o.closed((()=>{e.classList.remove("map__pin--active"),n=null}))};window.global.filtersForm.addEventListener("change",(()=>{o&&(o.close(),n&&(n.classList.remove("map__pin--active"),n=null))})),window.render={createAd:o=>{const n=Math.min(o.length,5);t.innerHTML="";for(let t=0;t<n;t++){const n=window.pin.renderAd(o[t]);e.appendChild(n),n.addEventListener("click",(()=>{r(n,o[t])})),n.addEventListener("keydown",(e=>{window.util.isEnter(e)&&r(n,o[t])}))}t.appendChild(e),window.global.similarAdElement.appendChild(t)}}})(),(()=>{const e=window.global.filtersForm.querySelector("select[name = housing-type]"),t=window.global.filtersForm.querySelector("select[name = housing-price]"),o=window.global.filtersForm.querySelector("select[name = housing-rooms]"),n=window.global.filtersForm.querySelector("select[name = housing-guests]"),r=window.global.filtersForm.querySelectorAll(".map__checkbox"),a={onHousingTypeChange:()=>{},onHousingPriceChange:()=>{},onHousingRoomsChange:()=>{},onHousingGuestsChange:()=>{},onHousingFeaturesChange:()=>{}};e.addEventListener("change",(()=>{const t=e.value;a.onHousingTypeChange(t)})),t.addEventListener("change",(()=>{const e=t.value;a.onHousingPriceChange(e)})),o.addEventListener("change",(()=>{const e=o.value;a.onHousingRoomsChange(e)})),n.addEventListener("change",(()=>{const e=n.value;a.onHousingGuestsChange(e)}));let i=[];r.forEach((e=>{e.addEventListener("click",(()=>{if(e.checked)i.push(e.value);else{const t=i.indexOf(e);i.splice(t,1)}a.onHousingFeaturesChange(i)}))})),window.filter={setHousingTypeHandler:e=>{a.onHousingTypeChange=e},setHousingPriceHandler:e=>{a.onHousingPriceChange=e},setHousingRoomsHandler:e=>{a.onHousingRoomsChange=e},setHousingGuestsHandler:e=>{a.onHousingGuestsChange=e},setHousingFeaturesHandler:e=>{a.onHousingFeaturesChange=e}}})(),window.debounce={setClickInterval:e=>{let t=null;return(...o)=>{t&&window.clearTimeout(t),t=window.setTimeout((()=>{e(...o)}),500)}}},(()=>{const e=window.global.map.querySelector(".map__pin--main"),t={top:50,right:window.global.map.offsetWidth-Math.floor(e.clientWidth/2),left:-Math.floor(e.clientWidth/2),bottom:550};window.move={getNewLocation:(o,n)=>{let r={x:t.left,y:t.top};o>t.right?r.x=t.right:o>t.left&&(r.x=o),n>t.bottom?r.y=t.bottom:n>t.top&&(r.y=n),(t=>{e.style.left=t.x+"px",e.style.top=t.y+"px",window.util.getNewMainPinAddress(t.x,t.y,80)})(r)}}})(),(()=>{const e=window.global.adForm.querySelector("select[name = capacity]"),t=window.global.adForm.querySelector("input[name = price]"),o=document.createDocumentFragment(),n={100:["не для гостей"],1:["для 1 гостя"],2:["для 1 гостя","для 2 гостей"],3:["для 1 гостя","для 2 гостей","для 3 гостей"]},r={"не для гостей":0,"для 1 гостя":1,"для 2 гостей":2,"для 3 гостей":3},a={bungalow:0,flat:1e3,house:5e3,palace:1e4};window.form={renderCapacityList:t=>{e.innerHTML="",n[t].forEach((e=>{o.appendChild((e=>{const t=document.createElement("option");return t.textContent=e,t.value=r[e],t})(e))})),e.appendChild(o)},getPrice:e=>{t.min=a[e],t.max=1e6,t.placeholder=a[e]},synchronizeSelects:(e,t)=>{e.selectedIndex=[...e].findIndex((e=>e.value===t))},validateTextInput:(e,t,o)=>{const n=e.value.length;n<t?e.setCustomValidity("Ещё "+(t-n)+" символов"):n>o?e.setCustomValidity("Удалите лишние "+(n-o)+" символов"):e.setCustomValidity(""),e.reportValidity()}}})(),(()=>{const e=["gif","jpg","jpeg","png","svg"],t=window.global.adForm.querySelector(".ad-form__field input[type=file]"),o=window.global.adForm.querySelector(".ad-form-header__preview img"),n=window.global.adForm.querySelector(".ad-form__upload input[type=file]"),r=window.global.adForm.querySelector(".ad-form__photo"),a=document.createElement("img");a.src="img/muffin-grey.svg",a.width=70,a.height=70;const i=[o,r.appendChild(a)];[t,n].forEach(((t,o)=>{t.addEventListener("change",(()=>{const n=t.files[0],r=n.name.toLowerCase();if(e.some((e=>r.endsWith(e)))){const e=new FileReader;e.addEventListener("load",(()=>{i[o].src=e.result})),e.readAsDataURL(n)}}))}))})(),(()=>{const e=window.global.map.querySelector(".map__pin--main"),t=window.global.adForm.querySelectorAll("fieldset"),o=window.global.adForm.querySelector("input[name = title]"),n=window.global.adForm.querySelector("select[name = rooms]"),r=window.global.adForm.querySelector("select[name = type]"),a=window.global.adForm.querySelector("select[name = timein]"),i=window.global.adForm.querySelector("select[name = timeout]"),s=window.global.adForm.querySelector(".ad-form__reset"),l=window.global.filtersForm.querySelectorAll("select"),d=document.querySelector("#success").content.querySelector(".success"),c=document.querySelector("#error").content.querySelector(".error"),u=window.global.adForm.querySelector(".ad-form-header__preview img"),w=window.global.adForm.querySelector(".ad-form__photo img"),m={any:e=>e>0,middle:e=>e>=1e4&&e<5e4,low:e=>e<1e4,high:e=>e>5e4},p={any:e=>e>=0,1:e=>1===e,2:e=>2===e,3:e=>3===e},g={any:e=>e>=0,1:e=>1===e,2:e=>2===e,0:e=>0===e};let f=e.offsetLeft,y=e.offsetTop;const h=()=>{window.global.map.classList.remove("map--faded"),window.global.adForm.classList.remove("ad-form--disabled"),window.util.setDisable(t,!1),window.util.setDisable(l,!1),window.load.getData(x,H)},v=()=>{window.global.map.classList.add("map--faded"),window.global.map.querySelector(".pins__container").innerHTML="",window.global.adForm.classList.add("ad-form--disabled"),window.util.setDisable(t,!0),window.util.setDisable(l,!0),window.global.adForm.reset(),window.form.getPrice(r.value),window.form.renderCapacityList(n.value),window.util.getNewMainPinAddress(570,375,65),e.style.left="570px",e.style.top="375px",u.src="img/muffin-grey.svg",w.src="img/muffin-grey.svg"};window.util.setDisable(t,!0),window.util.setDisable(l,!0),window.form.renderCapacityList(n.value),window.form.getPrice(r.value),window.util.getNewMainPinAddress(f,y,65),e.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY};const n=t=>{t.preventDefault();const n=o.x-t.clientX,r=o.y-t.clientY;o={x:t.clientX,y:t.clientY},f=e.offsetLeft,y=e.offsetTop,window.move.getNewLocation(f-n,y-r)},r=e=>{e.preventDefault(),n(e),window.global.map.removeEventListener("mousemove",n),document.removeEventListener("mouseup",r)};window.global.map.addEventListener("mousemove",n),document.addEventListener("mouseup",r),1===t.which&&(h(),window.util.getNewMainPinAddress(f,y,80))})),e.addEventListener("keydown",(e=>{window.util.isEnter(e)&&(h(),window.util.getNewMainPinAddress(f,y,80))})),window.global.adForm.addEventListener("submit",(e=>{e.preventDefault(),window.upload.sendData(new FormData(window.global.adForm),A,T)})),n.addEventListener("change",(e=>{const t=e.target.options,o=t[t.selectedIndex].value;window.form.renderCapacityList(o)})),r.addEventListener("change",(e=>{const t=e.target.options,o=t[t.selectedIndex].value;window.form.getPrice(o)})),o.addEventListener("input",(()=>{window.form.validateTextInput(o,30,100)})),a.addEventListener("change",(e=>{const t=e.target.options,o=t[t.selectedIndex].value;window.form.synchronizeSelects(i,o)})),i.addEventListener("change",(e=>{const t=e.target.options,o=t[t.selectedIndex].value;window.form.synchronizeSelects(a,o)})),s.addEventListener("click",(()=>{v()}));let b="any",_="any",L="any",E="any",S=[],q=[];const C=e=>{const t=e.offer.features;let o=0;return e.offer.type===b&&(o+=5),m[_](e.offer.price)&&(o+=4),p[L](e.offer.rooms)&&(o+=3),g[E](e.offer.guests)&&(o+=2),S.forEach((e=>{t.includes(e)&&(o+=1)})),o},F=()=>{window.render.createAd(q.sort(((e,t)=>{let o=C(t)-C(e);var n,r;return 0===o&&(n=e.offer.features,r=t.offer.features,o=n.length>r.length?1:n.length<r.length?-1:0),o})))};window.filter.setHousingTypeHandler(window.debounce.setClickInterval((e=>{b=e,F()}))),window.filter.setHousingPriceHandler(window.debounce.setClickInterval((e=>{_=e,F()}))),window.filter.setHousingRoomsHandler(window.debounce.setClickInterval((e=>{L=e,F()}))),window.filter.setHousingGuestsHandler(window.debounce.setClickInterval((e=>{E=e,F()}))),window.filter.setHousingFeaturesHandler(window.debounce.setClickInterval((e=>{S=e,F()})));const x=e=>{q=e,F()},H=e=>{const t=document.createElement("div");t.style="z-index: 100; padding: 15px 0; width: 100%; text-align: center; color: #FFFFFF; background-color: rgb(255, 36, 0);",t.style.position="fixed",t.style.left=0,t.style.top=0,t.style.fontSize="28px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},k=e=>{const t=D(e);document.addEventListener("keydown",t),e.addEventListener("click",t)},D=e=>{const t=()=>{document.removeEventListener("keydown",t),e.remove()};return t},A=()=>{document.body.insertAdjacentElement("afterbegin",d);const e=document.querySelector(".success");k(e),v()},T=()=>{document.querySelector("main").insertAdjacentElement("afterbegin",c);const e=document.querySelector(".error");k(e)}})()})();